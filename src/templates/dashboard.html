{% extends "base.html" %}

{% block title %}Painel de Metas - Ramalho Pet Shop{% endblock %}

{% block content %}

  <!-- Indicador de mês vigente -->
<div class="month-indicator">
    <h3>Mês Vigente: <span id="current-month">{{ current_month }}</span></h3>
</div>

<div class="dashboard-container">
    <!-- Dados JSON para processamento pelo JavaScript -->
    {% if usuario_master and dados_lojas_json %}
    <script id="dados-lojas-json" type="application/json">{{ dados_lojas_json|safe }}</script>
    <span id="meta-grupo" style="display: none;">{{ meta_grupo }}</span>
    <span id="acumulado-grupo" style="display: none;">{{ acumulado_grupo }}</span>
    <span id="percentual-grupo" style="display: none;">{{ percentual_grupo }}</span>
    {% endif %}

    {% if usuario_loja and historico_json %}
    <script id="historico-json" type="application/json">{{ historico_json|safe }}</script>
    <script id="dados-meta-json" type="application/json">{{ dados_meta_json|safe }}</script>
    {% endif %}

    <div class="contador-regressivo" id="contador-regressivo">
        Contagem regressiva para o fim do mês: <span id="tempo-restante"></span>
    </div>

    <div class="frase-motivacional-painel" id="frase-motivacional-painel">
        <!-- Frase será carregada por JS -->
        Carregando inspiração...
    </div>

    <!-- Seção Master (Visível apenas para Vinícius Ramalho) -->
    {% if usuario_master %}
    <div class="card painel-master">
        <h2 class="card-header">Painel Consolidado - Master</h2>
        
        <!-- Seletor de mês/ano para visualização histórica -->
        <div class="month-year-selector">
            <form id="form-selecao-mes-ano" method="GET" action="{{ url_for('main.dashboard_master') }}">
                <div class="selector-container">
                    <label for="month-select">Mês:</label>
                    <select id="month-select" name="month">
                        <option value="1" {% if selected_month == 1 %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if selected_month == 2 %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if selected_month == 3 %}selected{% endif %}>Março</option>
                        <option value="4" {% if selected_month == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if selected_month == 5 %}selected{% endif %}>Maio</option>
                        <option value="6" {% if selected_month == 6 %}selected{% endif %}>Junho</option>
                        <option value="7" {% if selected_month == 7 %}selected{% endif %}>Julho</option>
                        <option value="8" {% if selected_month == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if selected_month == 9 %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if selected_month == 10 %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if selected_month == 11 %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if selected_month == 12 %}selected{% endif %}>Dezembro</option>
                    </select>
                    
                    <label for="year-select">Ano:</label>
                    <select id="year-select" name="year">
                        <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                        <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                        <option value="2026" {% if selected_year == 2026 %}selected{% endif %}>2026</option>
                    </select>
                    
                    <button type="submit" class="btn btn-secundario btn-sm">Visualizar</button>
                </div>
                <div class="viewing-period">
                    <p>Visualizando dados de: <strong>{{ selected_month_name }} de {{ selected_year }}</strong></p>
                </div>
            </form>
        </div>
        
        <div class="grid-metas">
            <div class="meta-consolidada">
                <h3>Total Geral do Grupo</h3>
                <p>Faturamento Diário: R$ <span id="master-faturamento-diario-total">0,00</span></p>
                <p>Meta Diária: R$ <span id="master-meta-diaria-total">0,00</span></p>
                <p>Atingido: <span id="master-percentual-total">0</span>%</p>
                <div class="barra-progresso">
                    <div class="progresso-atual" id="master-progresso-total" style="width: 0%;">0%</div>
                </div>
                <p>Acumulado no Mês: R$ <span id="master-acumulado-mes-total">0,00</span></p>
            </div>
        </div>
        
        <!-- Gráfico de Meta Mensal vs. Acumulado do Grupo -->
        <div class="grafico-meta-mensal">
            <h3>Meta Mensal vs. Acumulado do Grupo</h3>
            <div class="grafico-container">
                <div class="grafico-barra">
                    <div class="grafico-label">Meta Mensal</div>
                    <div class="grafico-valor">R$ <span id="meta-mensal-grupo">580.000,00</span></div>
                    <div class="barra-meta">
                        <div class="barra-preenchimento" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="grafico-barra">
                    <div class="grafico-label">Acumulado</div>
                    <div class="grafico-valor">R$ <span id="acumulado-mensal-grupo">0,00</span></div>
                    <div class="barra-acumulado">
                        <div class="barra-preenchimento" id="barra-acumulado-grupo" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="grafico-percentual">
                    <span id="percentual-meta-grupo">0</span>% da meta mensal atingida
                </div>
            </div>
        </div>
        
        <hr style="margin: 20px 0;">
        <h3>Desempenho por Loja</h3>
        <div class="grid-lojas-master">
            <!-- Lojas serão listadas aqui dinamicamente -->
            {% for loja in lojas %}
            <div class="card-loja-master">
                <h4 class="nome-loja">{{ loja.store_name }}</h4>
                <p>Faturamento Diário: R$ <span id="master-faturamento-{{ loja.id }}">0,00</span></p>
                <p>Meta Diária: R$ <span id="master-meta-{{ loja.id }}">0,00</span></p>
                <p>Atingido: <span id="master-percentual-{{ loja.id }}">0</span>%</p>
                <div class="barra-progresso">
                    <div class="progresso-atual" id="master-progresso-{{ loja.id }}" style="width: 0%;">0%</div>
                </div>
                <p>Acumulado no Mês: R$ <span id="master-acumulado-{{ loja.id }}">0,00</span></p>
                
                <!-- Tabela de Histórico Diário -->
                <div class="historico-diario-container">
                    <h5>Histórico Diário - {{ loja.store_name }}</h5>
                    <div class="tabela-container">
                        <table class="tabela-historico">
                            <thead>
                                <tr>
                                    <th>Dia</th>
                                    <th>Faturamento</th>
                                    <th>Meta</th>
                                    <th>% Atingido</th>
                                </tr>
                            </thead>
                            <tbody id="historico-diario-{{ loja.id }}">
                                <!-- Dados serão carregados dinamicamente -->
                                <tr><td colspan="4">Carregando dados...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Gráfico de Meta Mensal vs. Acumulado -->
                <div class="grafico-meta-mensal">
                    <h5>Meta Mensal vs. Acumulado - {{ loja.store_name }}</h5>
                    <div class="grafico-container">
                        <div class="grafico-barra">
                            <div class="grafico-label">Meta Mensal</div>
                            <div class="grafico-valor">R$ <span id="meta-mensal-{{ loja.id }}">0,00</span></div>
                            <div class="barra-meta">
                                <div class="barra-preenchimento" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="grafico-barra">
                            <div class="grafico-label">Acumulado</div>
                            <div class="grafico-valor">R$ <span id="acumulado-mensal-{{ loja.id }}">0,00</span></div>
                            <div class="barra-acumulado">
                                <div class="barra-preenchimento" id="barra-acumulado-{{ loja.id }}" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="grafico-percentual">
                            <span id="percentual-meta-{{ loja.id }}">0</span>% da meta mensal atingida
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Seção da Loja (Visível para usuários de loja) -->
    {% if usuario_loja %}
    <div class="card painel-loja">
        <h2 class="card-header">Painel da Loja: {{ nome_loja }}</h2>
        
        <!-- Seletor de mês/ano para visualização histórica -->
        <div class="month-year-selector">
            <form id="form-selecao-mes-ano-loja" method="GET" action="{{ url_for('main.dashboard_loja') }}">
                <div class="selector-container">
                    <label for="month-select-loja">Mês:</label>
                    <select id="month-select-loja" name="month">
                        <option value="1" {% if selected_month == 1 %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if selected_month == 2 %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if selected_month == 3 %}selected{% endif %}>Março</option>
                        <option value="4" {% if selected_month == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if selected_month == 5 %}selected{% endif %}>Maio</option>
                        <option value="6" {% if selected_month == 6 %}selected{% endif %}>Junho</option>
                        <option value="7" {% if selected_month == 7 %}selected{% endif %}>Julho</option>
                        <option value="8" {% if selected_month == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if selected_month == 9 %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if selected_month == 10 %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if selected_month == 11 %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if selected_month == 12 %}selected{% endif %}>Dezembro</option>
                    </select>
                    
                    <label for="year-select-loja">Ano:</label>
                    <select id="year-select-loja" name="year">
                        <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                        <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                        <option value="2026" {% if selected_year == 2026 %}selected{% endif %}>2026</option>
                    </select>
                    
                    <button type="submit" class="btn btn-secundario btn-sm">Visualizar</button>
                </div>
                <div class="viewing-period">
                    <p>Visualizando dados de: <strong>{{ selected_month_name|default(current_month) }} de {{ selected_year|default(current_year) }}</strong></p>
                </div>
            </form>
        </div>
        
        <form id="form-faturamento-diario" method="POST" action="{{ url_for('main.registrar_faturamento') }}">
            <div class="form-group">
                <label for="dia-faturamento">Selecione o Dia:</label>
                <select id="dia-faturamento" name="dia" class="form-control">
                    {% for i in range(1, 32) %}
                        <option value="{{ i }}" {% if i == dia_atual %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="faturamento-dia">Registrar Faturamento do Dia:</label>
                <input type="number" id="faturamento-dia" name="faturamento" step="0.01" min="0" required class="form-control">
            </div>
            <input type="hidden" name="mes" value="{{ selected_month|default(current_month_num) }}">
            <input type="hidden" name="ano" value="{{ selected_year|default(current_year) }}">
            <button type="submit" class="btn btn-principal">Salvar Faturamento</button>
        </form>
        
        <hr style="margin: 20px 0;">
        <div class="meta-info">
            <h3>Meta do Dia</h3>
            <p>Sua meta para hoje: R$ <span id="loja-meta-diaria">0,00</span></p>
            <p>Faturamento Registrado: R$ <span id="loja-faturamento-registrado">0,00</span></p>
            <p>Percentual Atingido: <span id="loja-percentual-atingido">0</span>%</p>
            <div class="barra-progresso">
                <div class="progresso-atual" id="loja-progresso-diario" style="width: 0%;">0%</div>
            </div>
            <p>Total Acumulado no Mês: R$ <span id="loja-acumulado-mes">0,00</span></p>
        </div>
        
        <!-- Gráficos detalhados para a loja (iguais aos do administrador) -->
        <hr style="margin: 20px 0;">
        <h3>Desempenho Detalhado - {{ nome_loja }}</h3>
        
        <!-- Gráfico de Meta Mensal vs. Acumulado -->
        <div class="grafico-meta-mensal">
            <h5>Meta Mensal vs. Acumulado</h5>
            <div class="grafico-container">
                <div class="grafico-barra">
                    <div class="grafico-label">Meta Mensal</div>
                    <div class="grafico-valor">R$ <span id="loja-meta-mensal">0,00</span></div>
                    <div class="barra-meta">
                        <div class="barra-preenchimento" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="grafico-barra">
                    <div class="grafico-label">Acumulado</div>
                    <div class="grafico-valor">R$ <span id="loja-acumulado-mensal">0,00</span></div>
                    <div class="barra-acumulado">
                        <div class="barra-preenchimento" id="loja-barra-acumulado" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="grafico-percentual">
                    <span id="loja-percentual-meta">0</span>% da meta mensal atingida
                </div>
            </div>
        </div>
        
        <!-- Tabela de Histórico Diário -->
        <div class="historico-diario-container">
            <h5>Histórico Diário</h5>
            <div class="tabela-container">
                <table class="tabela-historico">
                    <thead>
                        <tr>
                            <th>Dia</th>
                            <th>Faturamento</th>
                            <th>Meta</th>
                            <th>% Atingido</th>
                        </tr>
                    </thead>
                    <tbody id="loja-historico-diario">
                        <!-- Dados serão carregados dinamicamente -->
                        <tr><td colspan="4">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quadro de Medalhas (Público) -->
    <div class="card quadro-medalhas-container">
        <h2 class="card-header">Quadro de Medalhas do Mês</h2>
        <div class="quadro-medalhas" id="quadro-medalhas-geral">
            <!-- Medalhas serão carregadas aqui (ex: Alvarenga: 🏆🏆, Corbisier: 🏆) -->
            <p>Carregando medalhas...</p>
        </div>
        <div class="historico-medalhas-link">
            <a href="{{ url_for('main.historico_medalhas') }}" class="btn btn-secundario">Ver Histórico de Medalhas</a>
        </div>
    </div>

    <!-- Destaques do Dia -->
    <div id="destaques-do-dia">
        <!-- Mensagens de destaque aparecerão aqui -->
    </div>

    <!-- Alerta de Bônus -->
    <div id="alerta-bonus-equipe" class="alerta alerta-bonus" style="display: none;">
        🎉 Bônus de R$ 500 liberado para toda a equipe! 🎉
    </div>

</div>

<style>
.dashboard-container {
    padding: 1rem;
}
.grid-metas, .grid-lojas-master {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}
.meta-consolidada, .card-loja-master, .painel-loja .meta-info {
    padding: 1rem;
    border: 1px solid var(--cor-fundo-escuro);
    border-radius: 5px;
    background-color: #fff;
}
.painel-loja .meta-info h3, .meta-consolidada h3, .card-loja-master h4 {
    color: var(--cor-roxo-principal);
    margin-bottom: 0.5rem;
}
.quadro-medalhas-container {
    margin-top: 2rem;
}
.historico-medalhas-link {
    text-align: center;
    margin-top: 1rem;
}
#destaques-do-dia .alerta {
    margin-top: 1rem;
}
</style>

{% endblock %}

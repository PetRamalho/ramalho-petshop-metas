{% extends "base.html" %}

{% block title %}Painel de Metas - Ramalho Pet Shop{% endblock %}

{% block content %}

  <!-- Indicador de m√™s vigente -->
<div class="month-indicator">
    <h3>M√™s Vigente: <span id="current-month">{{ current_month }}</span></h3>
</div>

<div class="dashboard-container">
    <!-- Dados JSON para processamento pelo JavaScript -->
    {% if usuario_master and dados_lojas_json %}
    <script id="dados-lojas-json" type="application/json">{{ dados_lojas_json|safe }}</script>
    <span id="meta-grupo" style="display: none;">{{ meta_grupo }}</span>
    <span id="acumulado-grupo" style="display: none;">{{ acumulado_grupo }}</span>
    <span id="percentual-grupo" style="display: none;">{{ percentual_grupo }}</span>
    {% endif %}

    {% if usuario_loja and historico_json %}
    <script id="historico-json" type="application/json">{{ historico_json|safe }}</script>
    <script id="dados-meta-json" type="application/json">{{ dados_meta_json|safe }}</script>
    {% endif %}

    <div class="contador-regressivo" id="contador-regressivo">
        Contagem regressiva para o fim do m√™s: <span id="tempo-restante"></span>
    </div>

    <div class="frase-motivacional-painel" id="frase-motivacional-painel">
        <!-- Frase ser√° carregada por JS -->
        Carregando inspira√ß√£o...
    </div>

    <!-- Quadro de Medalhas Reformulado (lojas nas linhas) -->
    <div class="card quadro-medalhas">
        <h3 class="card-header">Quadro de Medalhas - {{ selected_month_name }} de {{ selected_year }}</h3>
        <div class="quadro-medalhas-content">
            <table class="tabela-medalhas">
                <thead>
                    <tr>
                        <th>Loja</th>
                        <th>Medalhas</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% if usuario_master %}
                        {% for loja in lojas %}
                        <tr>
                            <td class="nome-loja">{{ loja.store_name }}</td>
                            <td class="medalhas-loja">
                                {% if loja.id in medalhas_por_loja %}
                                    {% for medalha in medalhas_por_loja[loja.id] %}
                                        <span class="medalha" title="Meta atingida em {{ medalha.dia }}/{{ medalha.mes }}/{{ medalha.ano }}">üèÖ</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="sem-medalhas">Nenhuma medalha no per√≠odo</span>
                                {% endif %}
                            </td>
                            <td class="total-medalhas">
                                {% if loja.id in medalhas_por_loja %}
                                    {{ medalhas_por_loja[loja.id]|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% elif usuario_loja %}
                        <tr>
                            <td class="nome-loja">{{ nome_loja }}</td>
                            <td class="medalhas-loja">
                                {% if medalhas %}
                                    {% for medalha in medalhas %}
                                        <span class="medalha" title="Meta atingida em {{ medalha.dia }}/{{ medalha.mes }}/{{ medalha.ano }}">üèÖ</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="sem-medalhas">Nenhuma medalha no per√≠odo</span>
                                {% endif %}
                            </td>
                            <td class="total-medalhas">
                                {% if medalhas %}
                                    {{ medalhas|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="quadro-medalhas-footer">
            <a href="{{ url_for('main.historico_medalhas') }}" class="btn btn-secundario btn-sm">Ver Hist√≥rico Completo</a>
        </div>
    </div>

    <!-- Se√ß√£o Master (Vis√≠vel apenas para Vin√≠cius Ramalho) -->
    {% if usuario_master %}
    <div class="card painel-master">
        <h2 class="card-header">Painel Consolidado - Master</h2>
        
        <!-- Seletor de m√™s/ano para visualiza√ß√£o hist√≥rica -->
        <div class="month-year-selector">
            <form id="form-selecao-mes-ano" method="GET" action="{{ url_for('main.dashboard_master') }}">
                <div class="selector-container">
                    <label for="month-select">M√™s:</label>
                    <select id="month-select" name="month">
                        <option value="1" {% if selected_month == 1 %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if selected_month == 2 %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if selected_month == 3 %}selected{% endif %}>Mar√ßo</option>
                        <option value="4" {% if selected_month == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if selected_month == 5 %}selected{% endif %}>Maio</option>
                        <option value="6" {% if selected_month == 6 %}selected{% endif %}>Junho</option>
                        <option value="7" {% if selected_month == 7 %}selected{% endif %}>Julho</option>
                        <option value="8" {% if selected_month == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if selected_month == 9 %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if selected_month == 10 %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if selected_month == 11 %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if selected_month == 12 %}selected{% endif %}>Dezembro</option>
                    </select>
                    
                    <label for="year-select">Ano:</label>
                    <select id="year-select" name="year">
                        <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                        <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                        <option value="2026" {% if selected_year == 2026 %}selected{% endif %}>2026</option>
                    </select>
                    
                    <button type="submit" class="btn btn-secundario btn-sm">Visualizar</button>
                </div>
                <div class="viewing-period">
                    <p>Visualizando dados de: <strong>{{ selected_month_name }} de {{ selected_year }}</strong></p>
                </div>
            </form>
        </div>
        
        <div class="grid-metas">
            <div class="meta-consolidada">
                <h3>Total Geral do Grupo</h3>
                <p>Faturamento Di√°rio: R$ <span id="master-faturamento-diario-total">{{ acumulado_grupo|default('0,00') }}</span></p>
                <p>Meta Di√°ria: R$ <span id="master-meta-diaria-total">{{ meta_grupo|default('0,00') }}</span></p>
                <p>Atingido: <span id="master-percentual-total">{{ percentual_grupo|default('0') }}</span>%</p>
                <div class="barra-progresso">
                    <div class="progresso-atual" id="master-progresso-total" style="width: {{ percentual_grupo|default('0') }}%;">{{ percentual_grupo|default('0') }}%</div>
                </div>
                <p>Acumulado no M√™s: R$ <span id="master-acumulado-mes-total">{{ acumulado_grupo|default('0,00') }}</span></p>
            </div>
        </div>
        
        <!-- Gr√°fico de Meta Mensal vs. Acumulado do Grupo -->
        <div class="grafico-meta-mensal">
            <h3>Meta Mensal vs. Acumulado do Grupo</h3>
            <div class="grafico-container">
                <div class="grafico-barra">
                    <div class="grafico-label">Meta Mensal</div>
                    <div class="grafico-valor">R$ <span id="meta-mensal-grupo">{{ meta_grupo|default('0,00') }}</span></div>
                    <div class="barra-meta">
                        <div class="barra-preenchimento" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="grafico-barra">
                    <div class="grafico-label">Acumulado</div>
                    <div class="grafico-valor">R$ <span id="acumulado-mensal-grupo">{{ acumulado_grupo|default('0,00') }}</span></div>
                    <div class="barra-acumulado">
                        <div class="barra-preenchimento" id="barra-acumulado-grupo" style="width: {{ percentual_grupo|default('0') }}%;"></div>
                    </div>
                </div>
                <div class="grafico-percentual">
                    <span id="percentual-meta-grupo">{{ percentual_grupo|default('0') }}</span>% da meta mensal atingida
                </div>
            </div>
        </div>
        
        <hr style="margin: 20px 0;">
        <h3>Desempenho por Loja</h3>
        <div class="grid-lojas-master">
            <!-- Lojas ser√£o listadas aqui dinamicamente -->
            {% for loja in lojas %}
            <div class="card-loja-master">
                <h4 class="nome-loja">{{ loja.store_name }}</h4>
                <p>Faturamento Di√°rio: R$ <span id="master-faturamento-{{ loja.id }}">{{ dados_lojas[loja.id].meta_mensal.acumulado|default('0,00') }}</span></p>
                <p>Meta Di√°ria: R$ <span id="master-meta-{{ loja.id }}">{{ dados_lojas[loja.id].meta_mensal.meta_mensal|default('0,00') }}</span></p>
                <p>Atingido: <span id="master-percentual-{{ loja.id }}">{{ dados_lojas[loja.id].meta_mensal.percentual|default('0') }}</span>%</p>
                <div class="barra-progresso">
                    <div class="progresso-atual" id="master-progresso-{{ loja.id }}" style="width: {{ dados_lojas[loja.id].meta_mensal.percentual|default('0') }}%;">{{ dados_lojas[loja.id].meta_mensal.percentual|default('0') }}%</div>
                </div>
                <p>Acumulado no M√™s: R$ <span id="master-acumulado-{{ loja.id }}">{{ dados_lojas[loja.id].meta_mensal.acumulado|default('0,00') }}</span></p>
                
                <!-- Tabela de Hist√≥rico Di√°rio -->
                <div class="historico-diario-container">
                    <h5>Hist√≥rico Di√°rio - {{ loja.store_name }}</h5>
                    <div class="tabela-container">
                        <table class="tabela-historico">
                            <thead>
                                <tr>
                                    <th>Dia</th>
                                    <th>Faturamento</th>
                                    <th>Meta</th>
                                    <th>% Atingido</th>
                                </tr>
                            </thead>
                            <tbody id="historico-diario-{{ loja.id }}">
                                <!-- Dados ser√£o carregados dinamicamente -->
                                {% for dia in dados_lojas[loja.id].historico %}
                                <tr>
                                    <td>{{ dia.dia }}</td>
                                    <td>R$ {{ dia.faturamento|default('0,00') }}</td>
                                    <td>R$ {{ dia.meta|default('0,00') }}</td>
                                    <td class="{% if dia.percentual >= 100 %}meta-atingida{% else %}meta-nao-atingida{% endif %}">{{ dia.percentual|default('0') }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Gr√°fico de Meta Mensal vs. Acumulado -->
                <div class="grafico-meta-mensal">
                    <h5>Meta Mensal vs. Acumulado - {{ loja.store_name }}</h5>
                    <div class="grafico-container">
                        <div class="grafico-barra">
                            <div class="grafico-label">Meta Mensal</div>
                            <div class="grafico-valor">R$ <span id="meta-mensal-{{ loja.id }}">{{ dados_lojas[loja.id].meta_mensal.meta_mensal|default('0,00') }}</span></div>
                            <div class="barra-meta">
                                <div class="barra-preenchimento" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="grafico-barra">
                            <div class="grafico-label">Acumulado</div>
                            <div class="grafico-valor">R$ <span id="acumulado-mensal-{{ loja.id }}">{{ dados_lojas[loja.id].meta_mensal.acumulado|default('0,00') }}</span></div>
                            <div class="barra-acumulado">
                                <div class="barra-preenchimento" id="barra-acumulado-{{ loja.id }}" style="width: {{ dados_lojas[loja.id].meta_mensal.percentual|default('0') }}%;"></div>
                            </div>
                        </div>
                        <div class="grafico-percentual">
                            <span id="percentual-meta-{{ loja.id }}">{{ dados_lojas[loja.id].meta_mensal.percentual|default('0') }}</span>% da meta mensal atingida
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Se√ß√£o da Loja (Vis√≠vel para usu√°rios de loja) -->
    {% if usuario_loja %}
    <div class="card painel-loja">
        <h2 class="card-header">Painel da Loja: {{ nome_loja }}</h2>
        
        <!-- Seletor de m√™s/ano para visualiza√ß√£o hist√≥rica -->
        <div class="month-year-selector">
            <form id="form-selecao-mes-ano-loja" method="GET" action="{{ url_for('main.dashboard_loja') }}">
                <div class="selector-container">
                    <label for="month-select-loja">M√™s:</label>
                    <select id="month-select-loja" name="month">
                        <option value="1" {% if selected_month == 1 %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if selected_month == 2 %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if selected_month == 3 %}selected{% endif %}>Mar√ßo</option>
                        <option value="4" {% if selected_month == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if selected_month == 5 %}selected{% endif %}>Maio</option>
                        <option value="6" {% if selected_month == 6 %}selected{% endif %}>Junho</option>
                        <option value="7" {% if selected_month == 7 %}selected{% endif %}>Julho</option>
                        <option value="8" {% if selected_month == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if selected_month == 9 %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if selected_month == 10 %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if selected_month == 11 %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if selected_month == 12 %}selected{% endif %}>Dezembro</option>
                    </select>
                    
                    <label for="year-select-loja">Ano:</label>
                    <select id="year-select-loja" name="year">
                        <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                        <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                        <option value="2026" {% if selected_year == 2026 %}selected{% endif %}>2026</option>
                    </select>
                    
                    <button type="submit" class="btn btn-secundario btn-sm">Visualizar</button>
                </div>
                <div class="viewing-period">
                    <p>Visualizando dados de: <strong>{{ selected_month_name|default(current_month) }} de {{ selected_year|default(current_year) }}</strong></p>
                </div>
            </form>
        </div>
        
        <form id="form-faturamento-diario" method="POST" action="{{ url_for('main.registrar_faturamento') }}">
            <div class="form-group">
                <label for="dia-faturamento">Selecione o Dia:</label>
                <select id="dia-faturamento" name="dia" class="form-control">
                    {% for i in range(1, 32) %}
                        <option value="{{ i }}" {% if i == dia_atual %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="faturamento-dia">Registrar Faturamento do Dia:</label>
                <input type="number" id="faturamento-dia" name="faturamento" step="0.01" min="0" required class="form-control">
            </div>
            <input type="hidden" name="mes" value="{{ selected_month|default(current_month_num) }}">
            <input type="hidden" name="ano" value="{{ selected_year|default(current_year) }}">
            <button type="submit" class="btn btn-principal">Salvar Faturamento</button>
        </form>
        
        <hr style="margin: 20px 0;">
        <div class="meta-info">
            <h3>Meta do Dia</h3>
            <p>Sua meta para hoje: R$ <span id="loja-meta-diaria">{{ dados_hoje.meta|default('0,00') }}</span></p>
            <p>Faturamento Registrado: R$ <span id="loja-faturamento-registrado">{{ dados_hoje.faturamento|default('0,00') }}</span></p>
            <p>Percentual Atingido: <span id="loja-percentual-atingido">{{ dados_hoje.percentual|default('0') }}</span>%</p>
            <div class="barra-progresso">
                <div class="progresso-atual" id="loja-progresso-diario" style="width: {{ dados_hoje.percentual|default('0') }}%;">{{ dados_hoje.percentual|default('0') }}%</div>
            </div>
            <p>Total Acumulado no M√™s: R$ <span id="loja-acumulado-mes">{{ dados_meta.acumulado|default('0,00') }}</span></p>
        </div>
        
        <!-- Gr√°ficos detalhados para a loja (iguais aos do administrador) -->
        <hr style="margin: 20px 0;">
        <h3>Desempenho Detalhado - {{ nome_loja }}</h3>
        
        <!-- Gr√°fico de Meta Mensal vs. Acumulado -->
        <div class="grafico-meta-mensal">
            <h5>Meta Mensal vs. Acumulado</h5>
            <div class="grafico-container">
                <div class="grafico-barra">
                    <div class="grafico-label">Meta Mensal</div>
                    <div class="grafico-valor">R$ <span id="loja-meta-mensal">{{ dados_meta.meta_mensal|default('0,00') }}</span></div>
                    <div class="barra-meta">
                        <div class="barra-preenchimento" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="grafico-barra">
                    <div class="grafico-label">Acumulado</div>
                    <div class="grafico-valor">R$ <span id="loja-acumulado-mensal">{{ dados_meta.acumulado|default('0,00') }}</span></div>
                    <div class="barra-acumulado">
                        <div class="barra-preenchimento" id="loja-barra-acumulado" style="width: {{ dados_meta.percentual|default('0') }}%;"></div>
                    </div>
                </div>
                <div class="grafico-percentual">
                    <span id="loja-percentual-meta">{{ dados_meta.percentual|default('0') }}</span>% da meta mensal atingida
                </div>
            </div>
        </div>
        
        <!-- Tabela de Hist√≥rico Di√°rio -->
        <div class="historico-diario-container">
            <h5>Hist√≥rico Di√°rio</h5>
            <div class="tabela-container">
                <table class="tabela-historico">
                    <thead>
                        <tr>
                            <th>Dia</th>
                            <th>Faturamento</th>
                            <th>Meta</th>
                            <th>% Atingido</th>
                        </tr>
                    </thead>
                    <tbody id="loja-historico-diario">
                        {% for dia in historico %}
                        <tr>
                            <td>{{ dia.dia }}</td>
                            <td>R$ {{ dia.faturamento|default('0,00') }}</td>
                            <td>R$ {{ dia.meta|default('0,00') }}</td>
                            <td class="{% if dia.percentual >= 100 %}meta-atingida{% else %}meta-nao-atingida{% endif %}">{{ dia.percentual|default('0') }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Link para o Quadro de Medalhas -->
    <div class="acoes-dashboard">
        <a href="{{ url_for('main.historico_medalhas') }}" class="btn btn-secundario">Ver Quadro de Medalhas</a>
        {% if usuario_master %}
        <a href="{{ url_for('main.admin') }}" class="btn btn-principal">Painel Administrativo</a>
        {% endif %}
    </div>
</div>

<style>
/* Estilos para o quadro de medalhas reformulado */
.quadro-medalhas {
    margin-bottom: 2rem;
}
.quadro-medalhas-content {
    padding: 1rem;
    overflow-x: auto;
}
.tabela-medalhas {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}
.tabela-medalhas th, 
.tabela-medalhas td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--cor-fundo-escuro);
}
.tabela-medalhas th {
    background-color: var(--cor-fundo-escuro);
    color: var(--cor-texto-claro);
}
.nome-loja {
    font-weight: bold;
    color: var(--cor-roxo-principal);
}
.medalhas-loja {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.medalha {
    font-size: 0.75em; /* Reduzido pela metade */
    cursor: help;
}
.total-medalhas {
    font-weight: bold;
    text-align: center;
}
.sem-medalhas {
    color: #999;
    font-style: italic;
}
.quadro-medalhas-footer {
    padding: 1rem;
    text-align: center;
}
.acoes-dashboard {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
}
</style>

{% endblock %}
